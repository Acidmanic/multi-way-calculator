<html>

<head>
    <title>Calculate</title>
</head>

<body data-bs-theme="dark">
    <link href="bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <script src="bootstrap/bootstrap.min.js"></script>
    <script src="js/model-utils.js"></script>


    <script src="js/models/db-per-decade/db-per-decade-plot.js"></script>
    <script src="js/models/db-per-decade/model.js"></script>
    

    <script src="js/models/first-order-rc-filter/circuit.js"></script>
    <script src="js/models/first-order-rc-filter/model.js"></script>

    <script src="js/models/second-order-rc-filter/circuit.js"></script>
    <script src="js/models/second-order-rc-filter/model.js"></script>

    <script src="js/models/ohm-example/image.js"></script>
    <script src="js/models/ohm-example/model.js"></script>



    <script src="js/dom-utils.js"></script>
    <script src="js/models-index.js"></script>

    <script lang="js">


        var modelsByName = {};

        var parametersUpdateObject = {};
        var calculatingParameterName = '';

        var paramChanges = {};
        var calcModel = {};

        function getSelectedUnit(param, unitCoEfficient) {

            for (let index = 0; index < param.units.length; index++) {

                const u = param.units[index];

                if (u.coEfficient == unitCoEfficient) return u;
            }
            return { name: '?', coEfficient: 1 };
        }


        function reCalculate() {

            var model = {};

            for (let index = 0; index < calcModel.parameters.length; index++) {

                const parameter = calcModel.parameters[index];

                if (parameter.name != calculatingParameterName) {

                    const updatedP = parametersUpdateObject[parameter.name];

                    if (updatedP) {
                        const p = {
                            value: updatedP.value,
                            unit: updatedP.unit
                        };

                        model[parameter.name] = p;
                    }
                }


            }

            console.log('call calc for', model);

            let calculated = calcModel.calculate(model);

            console.log(calculated);

            if (calculated.supported) {

                calculated.result.value = Math.round(calculated.result.value*1000)/1000;

                writeIntoInput(calculated.result.parameterName, calculated.result.value, calculated.result.unit.coEfficient);

                parametersUpdateObject[calculated.result.parameterName] = {
                    value: calculated.result.value,
                    unit: calculated.result.unit
                };
            }

        }


        function pushChange(param, value, unitCoEfficient) {

            const u = getSelectedUnit(param, unitCoEfficient);

            parametersUpdateObject[param.name] = {
                value: parseFloat(value),
                unit: u
            };

            reCalculate();

        }

        function changeProcess(value, unitCoEfficient, elementName, param) {

            let obj = base64ToObject(param);

            pushChange(obj, value, unitCoEfficient);
        }

        function onOutputselected(paramName) {

            console.log('param selected', paramName);
            calculatingParameterName = paramName;
            reCalculate();
        }

        function initializeChanges() {
            for (let index = 0; index < calcModel.parameters.length; index++) {

                const param = calcModel.parameters[index];

                pushChange(param, param.defaultValue, param.defaultUnit);
            }
        }

        function initializeModel() {

            const select = document.getElementById('slc-models');

            let modelName = select.value;

            const m = modelsByName[modelName];

            if (m) {

                console.log('selected model:', m);

                var supported = supportedCalculations(m);

                console.log('supported',supported);

                writeInto('spnTitle', m.name);

                var inputs = createInputs(supported.parameters, 'changeProcess', 'onOutputselected');

                console.log(inputs);

                writeInto("divParameters", inputs.content);

                calcModel = m;

                inputs.reset();

                initializeChanges();


                var divCircuit = document.getElementById('div-circuit');

                if (divCircuit) {

                    if (m.circuit) {
                        divCircuit.innerHTML = m.circuit;
                    } else {
                        divCircuit.innerHTML = '';
                    }
                }

            }

        }

        function initializeModels() {

            var allModules = createAllModels();

            var options = '';

            const qt = "'";

            for (let index = 0; index < allModules.length; index++) {

                const m = allModules[index];

                modelsByName[m.name] = m;

                options += '<option value="' + m.name + '">' + m.name + '</option>';

            }
            const select = document.getElementById('slc-models');

            select.innerHTML = options;
        }

        function initializeDefaultModel() {

            const select = document.getElementById('slc-models');

            initializeModel(select.value);


        }
        function everything() {

            initializeModels();

            initializeDefaultModel();

        }

        // $(function () {
        //     $('[data-toggle="tooltip"]').tooltip()
        // })

    </script>

    <div class="container">
        <h1>Multi-way calculator</h1>

        <label for="slc-models">Select A Model For Calculation</label>
        <select class="form-control" id="slc-models" onchange="initializeModel(event.value)">
        </select>


        <h2>Calculate <span id="spnTitle"></span></h2>
        <form class="container">
            <div class="row d-flex align-items-center">
                <div id="divParameters" class="col-12 col-sm-6">

                </div>
                <div id="div-circuit" class="col-12 col-sm-6 input-group-text text-primary">

                </div>
            </div>
        </form>
    </div>

    <script lang="js">everything()</script>

</body>

</html>